@page "/testchart"
@rendermode InteractiveServer
@using CCP.Repositori.Entities
@using CCP.Repositori.Enums
@using CCP.Repositori.ResultData
@using CCP.Service.DTOs
@using MudBlazor
@using CCPProject.Components.Layout
@layout Layout1
@inject IDialogService DialogService
@inject NavigationManager navigationManager

<div class="d-flex">
    <div class="form-container p-3">
        <h3>Guest Measurement Form</h3>

        <EditForm EditContext="@editContext" OnValidSubmit="@HandleValidSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="mb-3">
                <label for="gender" class="form-label">Gender</label>
                <InputSelect id="gender" class="form-select" @bind-Value="guestMeasurement.Gender">
                    <option value="">Select Gender</option>
                    <option value="@Gender.Male">Male</option>
                    <option value="@Gender.Female">Female</option>
                </InputSelect>
                <ValidationMessage For="@(() => guestMeasurement.Gender)" />
            </div>

            <div class="mb-3">
                <label for="height" class="form-label">Height (cm)</label>
                <InputNumber id="height" class="form-control" @bind-Value="guestMeasurement.Height" min="40" max="180" />
                <ValidationMessage For="@(() => guestMeasurement.Height)" />
            </div>

            <div class="mb-3">
                <label for="weight" class="form-label">Weight (kg)</label>
                <InputNumber id="weight" class="form-control" @bind-Value="guestMeasurement.Weight" min="3" max="75" />
                <ValidationMessage For="@(() => guestMeasurement.Weight)" />
            </div>

            <div class="mb-3">
                <label for="headCircumference" class="form-label">Head Circumference (cm)</label>
                <InputNumber id="headCircumference" class="form-control" @bind-Value="guestMeasurement.HeadCircumference" />
                <ValidationMessage For="@(() => guestMeasurement.HeadCircumference)" />
            </div>

            <div class="mb-3">
                <label for="dateOfBirth" class="form-label">Date of Birth</label>
                <InputDate id="dateOfBirth" class="form-control" @bind-Value="guestMeasurement.DateOfBirth"
                           Min="@minDate.ToString("yyyy-MM-dd")" Max="@DateTime.Today.ToString("yyyy-MM-dd")" />
                <ValidationMessage For="@(() => guestMeasurement.DateOfBirth)" />
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary" disabled="@(!editContext?.Validate())">Submit</button>
                <button type="button" class="btn btn-secondary" @onclick="ResetForm">Reset</button>
            </div>
        </EditForm>

        @if (isSubmitted)
        {
            <div class="mt-3 alert alert-success">
                <h4>Submitted Data:</h4>
                <p>Gender: @guestMeasurement.Gender</p>
                <p>Height: @guestMeasurement.Height cm</p>
                <p>Weight: @guestMeasurement.Weight kg</p>
                <p>Head Circumference: @guestMeasurement.HeadCircumference cm</p>
                <p>Date of Birth: @guestMeasurement.DateOfBirth.ToShortDateString()</p>
                <p>Age in Years: @CalculateAgeInYears(guestMeasurement.DateOfBirth)</p>
                <p>BMI: @bmi.ToString("F2")</p>
                <h3 style="color: red;">BMI Rating: @bmiRating</h3>
            </div>
        }
    </div>
    <div class="chart-container p-3">
        @if (showChart)
        {
            <p>Height Chart</p>
            <MudChart ChartType="ChartType.Line"
                      ChartSeries="@HeightSeries"
                      XAxisLabels="@XAxisLabels"
                      Width="100%"
                      Height="350px"
                      ChartOptions="options">
            </MudChart>
            <p>Weight Chart</p>
            <MudChart ChartType="ChartType.Line"
                      ChartSeries="@WeightSeries"
                      XAxisLabels="@XAxisLabels"
                      Width="100%"
                      Height="350px"
                      ChartOptions="options">
            </MudChart>
        }
    </div>
</div>

@code {
    private GuestMeasurementInputDto guestMeasurement = new GuestMeasurementInputDto();
    private EditContext? editContext;
    private bool isSubmitted = false;
    private bool showChart = false;
    private ChartOptions options = new ChartOptions();
    public List<ChartSeries> HeightSeries = new List<ChartSeries>();
    public List<ChartSeries> WeightSeries = new List<ChartSeries>();
    public string[] XAxisLabels = Array.Empty<string>();
    private double bmi;
    private BmiRating bmiRating;
    private double minHeight;
    private double maxHeight;
    private DateTime minDate = DateTime.Today.AddYears(-20);

    protected override void OnInitialized()
    {
        // Initialize guestMeasurement with empty/default values
        guestMeasurement = new GuestMeasurementInputDto
            {
                Gender = Gender.Male,
                Height = 0,
                Weight = 0,
                HeadCircumference = 0,
                DateOfBirth = DateTime.MinValue
            };
        editContext = new EditContext(guestMeasurement);

        options.InterpolationOption = InterpolationOption.NaturalSpline;
        options.YAxisFormat = "F0";
        XAxisLabels = MeasurementStandards.MaleHeightStandard.Keys.Select(k => k.ToString()).ToArray();

        minHeight = Math.Min(
            MeasurementStandards.MaleHeightStandard.Values.Min(),
            MeasurementStandards.FemaleHeightStandard.Values.Min());
        maxHeight = Math.Max(
            MeasurementStandards.MaleHeightStandard.Values.Max(),
            MeasurementStandards.FemaleHeightStandard.Values.Max());

        // Subscribe to field changes to update button state
        editContext.OnFieldChanged += (sender, e) => StateHasChanged();
    }

    private async Task HandleValidSubmit()
    {
        if (editContext == null || !editContext.Validate()) return;

        isSubmitted = true;
        showChart = true;

        bmi = CalculateBmi(guestMeasurement.Weight, guestMeasurement.Height);
        bmiRating = MeasurementStandards.GetBmiRating((float)bmi);

        int age = CalculateAgeInYears(guestMeasurement.DateOfBirth);

        // Create arrays for the user's data with a single point
        double[] heightData = new double[XAxisLabels.Length];
        double[] weightData = new double[XAxisLabels.Length];
        Array.Fill(heightData, 0); // Use 0 instead of NaN to ensure chart renders
        Array.Fill(weightData, 0);

        // Set the user's height and weight at their age index
        if (age >= 1 && age <= 20) // Ensure age is within the chart range
        {
            int index = age - 1; // Adjust for 0-based array index
            heightData[index] = guestMeasurement.Height;
            weightData[index] = guestMeasurement.Weight;
        }

        // Clear previous series to avoid duplication
        HeightSeries.Clear();
        WeightSeries.Clear();

        if (guestMeasurement.Gender == Gender.Male)
        {
            HeightSeries = new List<ChartSeries>
            {
                new ChartSeries { Name = "Male Height Standard", Data = MeasurementStandards.MaleHeightStandard.Values.Select(h => (double)h).ToArray() },
                new ChartSeries { Name = "Male Height OverHeight", Data = MeasurementStandards.MaleOverHeight.Values.Select(h => (double)h).ToArray() },
                new ChartSeries { Name = "Male Height UnderHeight", Data = MeasurementStandards.MaleUnderHeight.Values.Select(h => (double)h).ToArray() },
                new ChartSeries { Name = "Your Height", Data = heightData } // User's height point
            };
            WeightSeries = new List<ChartSeries>
            {
                new ChartSeries { Name = "Male Weight Standard", Data = MeasurementStandards.MaleWeightStandard.Values.Select(w => (double)w).ToArray() },
                new ChartSeries { Name = "Male Weight OverWeight", Data = MeasurementStandards.MaleOverWeight.Values.Select(w => (double)w).ToArray() },
                new ChartSeries { Name = "Male Weight UnderWeight", Data = MeasurementStandards.MaleUnderWeight.Values.Select(w => (double)w).ToArray() },
                new ChartSeries { Name = "Your Weight", Data = weightData } // User's weight point
            };
        }
        else if (guestMeasurement.Gender == Gender.Female)
        {
            HeightSeries = new List<ChartSeries>
            {
                new ChartSeries { Name = "Female Height Standard", Data = MeasurementStandards.FemaleHeightStandard.Values.Select(h => (double)h).ToArray() },
                new ChartSeries { Name = "Female Height OverHeight", Data = MeasurementStandards.FemaleOverHeight.Values.Select(h => (double)h).ToArray() },
                new ChartSeries { Name = "Female Height UnderHeight", Data = MeasurementStandards.FemaleUnderHeight.Values.Select(h => (double)h).ToArray() },
                new ChartSeries { Name = "Your Height", Data = heightData } // User's height point
            };
            WeightSeries = new List<ChartSeries>
            {
                new ChartSeries { Name = "Female Weight Standard", Data = MeasurementStandards.FemaleWeightStandard.Values.Select(w => (double)w).ToArray() },
                new ChartSeries { Name = "Female Weight OverWeight", Data = MeasurementStandards.FemaleOverWeight.Values.Select(w => (double)w).ToArray() },
                new ChartSeries { Name = "Female Weight UnderWeight", Data = MeasurementStandards.FemaleUnderWeight.Values.Select(w => (double)w).ToArray() },
                new ChartSeries { Name = "Your Weight", Data = weightData } // User's weight point
            };
        }

        await DialogService.ShowMessageBox("Form Submitted", "The guest measurement data has been submitted successfully.");
        StateHasChanged();
    }

    private double CalculateBmi(float weight, float heightCm)
    {
        double heightM = heightCm / 100.0;
        if (heightM <= 0) return 0; // Avoid division by zero
        return weight / (heightM * heightM);
    }

    private int CalculateAgeInYears(DateTime dateOfBirth)
    {
        var today = DateTime.Today;
        int years = today.Year - dateOfBirth.Year;
        if (dateOfBirth.Date > today.AddYears(-years)) years--;
        return years >= 0 ? years : 0;
    }

    private void ResetForm()
    {
        guestMeasurement = new GuestMeasurementInputDto
            {
                Gender = Gender.Male,
                Height = 0,
                Weight = 0,
                HeadCircumference = 0,
                DateOfBirth = DateTime.MinValue
            };
        editContext = new EditContext(guestMeasurement);
        editContext.OnFieldChanged += (sender, e) => StateHasChanged(); // Re-subscribe
        isSubmitted = false;
        showChart = false;
        bmi = 0;
        bmiRating = default;
        HeightSeries.Clear();
        WeightSeries.Clear();
        StateHasChanged();
    }
}

<style>
    .form-container {
        width: 30%;
    }

    .chart-container {
        width: 70%;
    }
</style>